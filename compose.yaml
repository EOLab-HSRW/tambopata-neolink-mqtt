services:
  mosquitto:
    image: eclipse-mosquitto
    container_name: mosquitto
    volumes:
      - ./mqtt/config:/mosquitto/config
      - ./mqtt/data:/mosquitto/data
      - ./mqtt/log:/mosquitto/log
    ports:
      - 1883:1883
      - 9001:9001
    stdin_open: true
    tty: true
    networks:
      - mqtt_default
    restart: unless-stopped

  neolink:
    image: quantumentangledandy/neolink
    container_name: neolink
    volumes:
      - ./neolink/config.toml:/etc/neolink.toml
    environment:
      - NEO_LINK_MODE=mqtt-rtsp
    networks:
      - mqtt_default
    depends_on:
      - mosquitto
    restart: unless-stopped

  mqtt-client-controller:
    build:
      context: .
      dockerfile: ./python_mqtt_client/Dockerfile.client
    image: python-mqtt-client:latest
    container_name: mqtt-client-controller
    volumes:
      - ./python_mqtt_client:/app/python_mqtt_client
    environment:
      - NEOLINK_MODE=controller
      - START_PRESET=0
      - END_PRESET=3
      - START_HOUR=17
      - START_MINUTE=0
      - NEXTCLOUD_WEBDAV_URL=https://cloud.eolab.de/remote.php/dav/files/USERNAME/
      - NEXTCLOUD_TARGET_DIR=/Photos
      - NEXTCLOUD_USERNAME=USERNAME
      - NEXTCLOUD_PASSWORD=PASSWORD
    networks:
      - mqtt_default
    depends_on:
      - mosquitto
    restart: unless-stopped

  mqtt-client-manual:
    build:
      context: .
      dockerfile: ./python_mqtt_client/Dockerfile.client
    image: python-mqtt-client:latest
    container_name: mqtt-client-manual
    volumes:
      - ./python_mqtt_client:/app/python_mqtt_client
    environment:
      - NEOLINK_MODE=manual
      - START_PRESET=0
      - END_PRESET=3
    networks:
      - mqtt_default
    depends_on:
      - mosquitto
    stdin_open: true
    tty: true
    command: [ "tail", "-f", "/dev/null" ] # overrides CMD â†’ container stays alive doing nothing
    restart: unless-stopped

networks:
  mqtt_default:
    driver: bridge
